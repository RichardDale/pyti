from __future__ import absolute_import
import unittest
import numpy as np

from tests.sample_data import SampleData
from pyti import stochastic


class TestStochastic(unittest.TestCase):
    def setUp(self):
        """Create data to use for testing."""
        self.high_data = SampleData().get_sample_high_data()
        self.low_data = SampleData().get_sample_low_data()
        self.close_data = SampleData().get_sample_close_data()

        self.percent_k_period_6_expected = [
            np.nan, np.nan, np.nan, np.nan, np.nan, 0.8605664488017413, 0.8272471910112414,
            0.8636959370904372, 0.6129554655870475, 0.39757085020243504,
            0.7353982300884937, 0.7935285053929075, 0.5970724191063166,
            0.16808929743926082, 0.26986211424819495, 0.08600215905001726,
            0.09062499999999929, 0.050721370604147865, 0.11168966414996272,
            0.0400962309542903, 0.06989696463380654, 0.43462132921174607,
            0.9133597883597917, 0.79265873015873, 0.6078042328042348,
            0.5681216931216935, 0.6118746564046197, 0.5273437499999976,
            0.19769803656059945, 0.8376996805111782, 0.4428115015974456,
            0.1641975308641951, 0.0653319283456274, 0.5534773445732342,
            0.7784510010537389, 0.9555749128919868, 0.9639540374626167,
            0.8073351172674325, 0.26305265496556396, 0.12205801860974387,
            0.28452809299750825, 0.7567118737890959, 0.9291983616149775,
            0.9456621004566186, 0.8907922912205563, 0.9415618448637313,
            0.9121114683815635, 0.9296824368114077, 0.4093816631130037,
            0.3057569296375258, 0.4207708779443273, 0.12098501070663795,
            0.08456098998232203, 0.08628318584070913, 0.10283687943262718,
            0.37553191489361754, 0.36927816901408844, 0.8648468708388766,
            0.14087631724903302, 0.27232390460344197, 0.16971713810316386,
            0.25623960066555646, 0.15491452991452848, 0.7589388696655085,
            0.5951557093425597, 0.8276315789473674, 0.8603896103896117,
            0.3357142857142836, 0.8399330730619078, 0.862439548629772,
            0.2609649122807011, 0.12065727699530243, 0.08508112386228646,
            0.1871784724970329, 0.3161851998417101, 0.12615384615384803,
            0.15297450424929457, 0.7252124645892399, 0.14758698092031453,
            0.8771295818275686, 0.9081214109926166, 0.8961196443007255,
            0.4454324979789805, 0.22433306386418564, 0.12452511608273696,
            0.2119037568594331, 0.37653018151118833, 0.5231788079470222,
            0.39007092198581456, 0.5939716312056792, 0.7936344969199189,
            0.78926829268293, 0.8217821782178193, 0.8287589498806679,
            0.831184056271981, 0.5156675749318853, 0.8283198826118915,
            0.8306709265175712, 0.8062827225130952, 0.7889072847682144,
            0.7052980132450358, 0.3075089392133546, 0.5101311084624529,
            0.15965874466788602, 0.2614259597806199, 0.3609467455621299,
            0.4378903539208933, 0.10965794768611993, 0.06364992541024508,
            0.053339411898792606, 0.05832819880879089, 0.05565824604641679,
            0.11438075742067612, 0.1341235184029932, 0.40709459459459774,
            0.23973256924546174, 0.2646264626462692, 0.09589041095890466,
            0.10964083175803298, 0.07465923172242783, 0.18681318681318476,
            0.07860824742268226, 0.0954861111111083, 0.06971225155740196,
            0.13501829065513976, 0.07129629629629466, 0.2819852941176463
        ]

        self.percent_k_period_8_expected = [
            np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, 0.9239488117001855,
            0.716488730723608, 0.5124508519003967, 0.7819110138584974,
            0.8286445012787694, 0.6046863189720324, 0.16808929743926082,
            0.26986211424819495, 0.08600215905001726, 0.09062499999999929,
            0.0482418524871354, 0.09198113207547316, 0.035823034210997716,
            0.0496832937450513, 0.27830562153602434, 0.7691450849345595,
            0.7409582689335388, 0.6078042328042348, 0.5681216931216935,
            0.7665343915343925, 0.7599206349206344, 0.15360336664913593,
            0.6896370331404534, 0.4428115015974456, 0.1641975308641951,
            0.0653319283456274, 0.5534773445732342, 0.7784510010537389,
            0.9555749128919868, 0.9639540374626167, 0.8073351172674325,
            0.4778844640327409, 0.49504171257673635, 0.4256831815152182,
            0.7594417077175706, 0.8790478826460004, 0.9456621004566186,
            0.8952054794520542, 0.9517211517644508, 0.9518590998043046,
            0.958059528411288, 0.6030381198051009, 0.47245625405055197,
            0.5385927505330504, 0.299786780383795, 0.08456098998232203,
            0.06563814866760262, 0.07895453307922923, 0.37553191489361754,
            0.29751773049645697, 0.46063829787234, 0.09871745044695202,
            0.27232390460344197, 0.16971713810316386, 0.25623960066555646,
            0.15491452991452848, 0.3514957264957221, 0.27564102564102355,
            0.8276315789473674, 0.8603896103896117, 0.3357142857142836,
            0.858968058968059, 0.8782691393247766, 0.2756582482536266,
            0.12065727699530243, 0.08508112386228646, 0.1871784724970329,
            0.3161851998417101, 0.08062930186824113, 0.08310249307479362,
            0.5959031657355707, 0.14758698092031453, 0.8771295818275686,
            0.9081214109926166, 0.8961196443007255, 0.4454324979789805,
            0.22433306386418564, 0.16168148746968466, 0.2453516572352439,
            0.37653018151118833, 0.2667792317433531, 0.18573237653018013,
            0.5546357615894059, 0.8282051282051297, 0.8230958230958262,
            0.8217821782178193, 0.8287589498806679, 0.8518518518518516,
            0.6342592592592633, 0.8628370457209891, 0.8636655948553048,
            0.8590476190476245, 0.8227936066713025, 0.7052980132450358,
            0.5190397350993393, 0.6597682119205266, 0.15965874466788602,
            0.2614259597806199, 0.3345521023766008, 0.38452163315052235,
            0.10541586073501243, 0.05594405594405725, 0.04735883424408082,
            0.05832819880879089, 0.05565824604641679, 0.09180529882932886,
            0.04195940671350462, 0.11578188806149532, 0.14433582518688862,
            0.21242774566474334, 0.09589041095890466, 0.10186160871092288,
            0.07026239067055311, 0.16852540272614452, 0.0705406186759194,
            0.05417384880571118, 0.0461780310473575, 0.12043903886087377,
            0.06409544950055349, 0.2367283950617273
        ]

        self.percent_k_period_10_expected = [
            np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan,
            0.727970749542964, 0.8358946212952797, 0.8555256064689998,
            0.6656010230179038, 0.1898976982097192, 0.26986211424819495,
            0.08600215905001726, 0.09062499999999929, 0.0482418524871354,
            0.09198113207547316, 0.034417484081913606, 0.042723404255318995,
            0.24898176022666843, 0.5467141726049093, 0.4744655581947728,
            0.5118351434140911, 0.5310664605873261, 0.7665343915343925,
            0.7599206349206344, 0.4679232804232813, 0.80489417989418,
            0.36454497632825184, 0.13599182004089855, 0.0653319283456274,
            0.5534773445732342, 0.7784510010537389, 0.9555749128919868,
            0.9639540374626167, 0.8073351172674325, 0.4778844640327409,
            0.49504171257673635, 0.5931056193924125, 0.8616401699984264,
            0.9029104643412573, 0.9461660257860188, 0.8952054794520542,
            0.9517211517644508, 0.9534707773784749, 0.9636941609503102,
            0.7612068965517238, 0.6853498260533443, 0.689882487818861,
            0.46791963707064316, 0.08456098998232203, 0.06563814866760262,
            0.07895453307922923, 0.2883201742444875, 0.22842363190852424,
            0.46063829787234, 0.08138417173982936, 0.15732137135533728,
            0.11892732219199599, 0.25623960066555646, 0.15491452991452848,
            0.3514957264957221, 0.27564102564102355, 0.6720085470085422,
            0.7077991452991442, 0.3357142857142836, 0.858968058968059,
            0.8782691393247766, 0.35901093675701207, 0.12065727699530243,
            0.08508112386228646, 0.1871784724970329, 0.3161851998417101,
            0.08062930186824113, 0.08310249307479362, 0.39396737457679487,
            0.08052663808940594, 0.7847575057736733, 0.9081214109926166,
            0.8961196443007255, 0.4454324979789805, 0.22433306386418564,
            0.16168148746968466, 0.2453516572352439, 0.4029911075181901,
            0.29789814066289416, 0.18573237653018013, 0.2828197551709595,
            0.4090333474039693, 0.8230958230958262, 0.8449304174950281,
            0.8466880341880342, 0.8518518518518516, 0.6342592592592633,
            0.8796296296296334, 0.8956179222058095, 0.8842544316996914,
            0.8536165327210126, 0.7825290164935892, 0.5962473940236309,
            0.6597682119205266, 0.15965874466788602, 0.2614259597806199,
            0.3345521023766008, 0.38452163315052235, 0.09963436928702304,
            0.05360134003350209, 0.04660426209918403, 0.052369537156555984,
            0.04997234003319261, 0.09180529882932886, 0.04195940671350462,
            0.09406713505074257, 0.04771863117870703, 0.06738482695393204,
            0.07714043515117319, 0.09294871794871709, 0.07026239067055311,
            0.1586005830903775, 0.06664845670581955, 0.050262737034496976,
            0.043166789125643285, 0.07917316692667808, 0.04340473506200581,
            0.21281908990011006
        ]

        self.percent_d_period_6_expected = [
            np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, 0.85050319230114,
            0.767966197896242, 0.6247407509599733, 0.581974848625992,
            0.6421658618946121, 0.7086663848625726, 0.5195634073128282,
            0.3450079435979241, 0.17465119024582434, 0.14882975776607052,
            0.0757828432180548, 0.08434534491803662, 0.0675024219028003,
            0.0738942865793532, 0.18153817493328095, 0.47262602740178145,
            0.7135466159100892, 0.7712742504409188, 0.6561948853615528,
            0.595933527443516, 0.5691133665087703, 0.44563881432173885,
            0.5209138223572584, 0.4927364062230744, 0.4815695709909396,
            0.22411365360242272, 0.26100226792768555, 0.46575342465753344,
            0.7625010861729867, 0.8993266504694475, 0.9089546892073453,
            0.6781139365652044, 0.39748193028091344, 0.2232129221909387,
            0.387765995132116, 0.6568127761338606, 0.8771907786202306,
            0.9218842510973841, 0.926005412180302, 0.9148218681552837,
            0.9277852500189008, 0.7503918561019917, 0.5482736765206457,
            0.378636490231619, 0.28250427276283036, 0.20877229287776244,
            0.0972763955098897, 0.09122701841855278, 0.18821732672231795,
            0.28254898778011106, 0.5365523182488608, 0.458333785700666,
            0.4260156975637839, 0.1943057866518796, 0.2327602144573874,
            0.1936237562277496, 0.3900310000818645, 0.5030030363075322,
            0.7272420526518119, 0.7610589662265129, 0.6745784916837542,
            0.6786789897219343, 0.6793623024686545, 0.6544458446574604,
            0.4146872459685919, 0.15556777104609668, 0.13097229111820727,
            0.19614826540034316, 0.2098391728308637, 0.1984378500816176,
            0.3347802716641275, 0.3419246499196163, 0.583309675779041,
            0.6442793245801666, 0.893790212373637, 0.7498911844241075,
            0.5219617353812972, 0.2647635593086344, 0.18692064560211855,
            0.23765301815111947, 0.3705375821058812, 0.4299266371480084,
            0.5024071203795053, 0.5925590167038043, 0.725624806936176,
            0.8015616559402227, 0.813269806927139, 0.8272417281234894,
            0.725203527028178, 0.7250571712719193, 0.7248861280204494,
            0.8217578438808526, 0.8086203112662936, 0.7668293401754483,
            0.6005714124088682, 0.5076460203069478, 0.3257662641145645,
            0.3104052709703196, 0.26067715000354524, 0.3534210197545477,
            0.30283168238971436, 0.20373274233908611, 0.07554909499838587,
            0.05843917870594286, 0.05577528558466676, 0.07612240075862793,
            0.1013875072900287, 0.218532956806089, 0.26031689408101755,
            0.30381787549544287, 0.2000831476168785, 0.15671923512106894,
            0.09339682481312182, 0.12370441676454852, 0.11336022198609828,
            0.12030251511565844, 0.08126887003039751, 0.10007221777455,
            0.09200894616961212, 0.1627666270230269
        ]

        self.percent_d_period_8_expected = [
            np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan,
            0.71762946477473, 0.670283532160834, 0.7076687890125545,
            0.7384139447030997, 0.5338067058966875, 0.34754591021982933,
            0.17465119024582434, 0.14882975776607052, 0.07495633717905065,
            0.07694932818753596, 0.05868200625786876, 0.05916248667717405,
            0.12127064983069112, 0.3657113334052117, 0.5961363251347075,
            0.7059691955574444, 0.638961398286489, 0.6474867724867736,
            0.6981922398589068, 0.5600194643680543, 0.5343870115700745,
            0.4286839671290117, 0.43221535520069804, 0.22411365360242272,
            0.26100226792768555, 0.46575342465753344, 0.7625010861729867,
            0.8993266504694475, 0.9089546892073453, 0.7497245395875968,
            0.5934204312923033, 0.4662031193748985, 0.5600555339365084,
            0.6880575906262631, 0.8613838969400632, 0.9066384875182244,
            0.9308629105577079, 0.9329285770069365, 0.9538799266600145,
            0.8376522493402311, 0.677851300755647, 0.5380290414629011,
            0.43694526165579917, 0.3076468402997225, 0.14999530634457323,
            0.0763845572430513, 0.17337486554681647, 0.2506680594897679,
            0.3778959810874715, 0.285624492938583, 0.27722655097424465,
            0.18025283105118595, 0.2327602144573874, 0.1936237562277496,
            0.254216619025269, 0.26068376068375804, 0.4849227770280377,
            0.6545540716593342, 0.6745784916837542, 0.6850239850239848,
            0.690983828002373, 0.6709651488488206, 0.42486155485790184,
            0.1604655497037385, 0.13097229111820727, 0.19614826540034316,
            0.1946643247356614, 0.15997233159491495, 0.2532116535595352,
            0.2755308799102263, 0.5402065761611513, 0.6442793245801666,
            0.893790212373637, 0.7498911844241075, 0.5219617353812972,
            0.27714901643761697, 0.2104554028563714, 0.2611877754053723,
            0.2962203568299284, 0.27634726326157383, 0.33571578995431306,
            0.522857755441572, 0.7353122376301205, 0.824361043172925,
            0.8245456503981045, 0.8341309933167796, 0.7716233536639278,
            0.7829827189440346, 0.7869206332785191, 0.8618500865413061,
            0.8485022735247439, 0.7957130796546542, 0.6823771183385592,
            0.6280353200883005, 0.4461555638959174, 0.3602843054563441,
            0.2518789356083689, 0.32683323176924767, 0.27482986542071186,
            0.181960516609864, 0.0695729169743835, 0.053877029665642985,
            0.053781759699762836, 0.06859724789484552, 0.06314098386308342,
            0.0831821978681096, 0.10069237332062952, 0.15751515297104243,
            0.15088466060351222, 0.13672658844485697, 0.08933813678012688,
            0.11354980070254017, 0.10310947069087235, 0.0977466234025917,
            0.05696416617632936, 0.07359697290464749, 0.07690417313626159,
            0.14042096114105151
        ]

        self.percent_d_period_10_expected = [
            np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan, np.nan,
            np.nan, np.nan, 0.8064636591024145, 0.7856737502607277, 0.570341442565541,
            0.37512027849193935, 0.18192065716931047, 0.14882975776607052,
            0.07495633717905065, 0.07694932818753596, 0.05821348954817406,
            0.056374006804235245, 0.10870754952130035, 0.2794731123622989,
            0.4233871636754502, 0.5110049580712578, 0.5057890540653966,
            0.6031453318452699, 0.6858404956807843, 0.6647927689594361,
            0.6775793650793652, 0.5457874788819044, 0.43514365875444344,
            0.18862290823825925, 0.25160036431992006, 0.46575342465753344,
            0.7625010861729867, 0.8993266504694475, 0.9089546892073453,
            0.7497245395875968, 0.5934204312923033, 0.5220105986672966,
            0.649929167322525, 0.7858854179106988, 0.9035722200419009,
            0.9147606565264436, 0.931030885667508, 0.9334658028649933,
            0.9562953633644119, 0.8927906116268364, 0.8034169611851261,
            0.7121464034746431, 0.614383983647616, 0.4141210382906087,
            0.20603959190685595, 0.0763845572430513, 0.1443042853304398,
            0.19856611307741368, 0.32579403467511725, 0.2568153671735645,
            0.23311461365583555, 0.11921095509572087, 0.17749609807096323,
            0.17669381759069366, 0.254216619025269, 0.26068376068375804,
            0.43304843304842927, 0.5518162393162367, 0.5718406593406566,
            0.6341604966604956, 0.690983828002373, 0.6987493783499491,
            0.45264578435903036, 0.188249779204867, 0.13097229111820727,
            0.19614826540034316, 0.1946643247356614, 0.15997233159491495,
            0.18589972317327655, 0.1858655019136648, 0.4197505061466247,
            0.5911351849518987, 0.8629995203556717, 0.7498911844241075,
            0.5219617353812972, 0.27714901643761697, 0.2104554028563714,
            0.2700080840743729, 0.315413635138776, 0.2955405415704215,
            0.25548342412134456, 0.2925284930350363, 0.504982975223585,
            0.6923531959982746, 0.8382380915929627, 0.8478234345116379,
            0.7775997150997164, 0.7885802469135829, 0.8031689370315688,
            0.8865006611783781, 0.8778296288755044, 0.8401333269714311,
            0.7441309810794109, 0.6795148741459155, 0.4718914502040146,
            0.3602843054563441, 0.2518789356083689, 0.32683323176924767,
            0.2729027016047154, 0.1792524474903492, 0.06661332380656972,
            0.0508583797630807, 0.04964871309631088, 0.06471572533969248,
            0.06124568185867537, 0.07594394686452535, 0.061248390980984745,
            0.06972353106112722, 0.06408129776127075, 0.07915799335127412,
            0.08011718125681445, 0.10727056390321589, 0.09850381015558339,
            0.09183725894356466, 0.053359327621986606, 0.05753423102893945,
            0.05524823037144239, 0.11179899729626465
        ]


    def test_percent_k_period_6(self):
        period = 6
        percent_k = stochastic.percent_k(self.high_data, self.low_data, self.close_data, period)
        np.testing.assert_array_equal(percent_k, self.percent_k_period_6_expected)

    def test_percent_k_period_8(self):
        period = 8
        percent_k = stochastic.percent_k(self.high_data, self.low_data, self.close_data, period)
        np.testing.assert_array_equal(percent_k, self.percent_k_period_8_expected)

    def test_percent_k_period_10(self):
        period = 10
        percent_k = stochastic.percent_k(self.high_data, self.low_data, self.close_data, period)
        np.testing.assert_array_equal(percent_k, self.percent_k_period_10_expected)

    def test_percent_k_invalid_period(self):
        period = 128
        with self.assertRaises(Exception):
            stochastic.percent_k(self.high_data, self.low_data, self.close_data, period)

    def test_percent_d_period_6(self):
        period = 6
        percent_d = stochastic.percent_d(self.high_data, self.low_data, self.close_data, period)
        print (percent_d.tolist())
        np.testing.assert_array_equal(percent_d, self.percent_d_period_6_expected)

    def test_percent_d_period_8(self):
        period = 8
        percent_d = stochastic.percent_d(self.high_data, self.low_data, self.close_data, period)
        np.testing.assert_array_equal(percent_d, self.percent_d_period_8_expected)

    def test_percent_d_period_10(self):
        period = 10
        percent_d = stochastic.percent_d(self.high_data, self.low_data, self.close_data, period)
        np.testing.assert_array_equal(percent_d, self.percent_d_period_10_expected)

    def test_percent_d_invalid_period(self):
        period = 128
        with self.assertRaises(Exception) as cm:
            stochastic.percent_d(self.high_data, self.low_data, self.close_data, period)
        expected = "Error: data_len < period"
        self.assertEqual(str(cm.exception), expected)
